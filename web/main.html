<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Netflix</title> 
    <style>
        .apagar {
            background-color: #e04222; 
            border: 1px solid #222; 
            padding: 10px; 
            border-radius: 3px;
            font-weight: bold;
            cursor: pointer;
        }
        .apagar:hover {

            background-color: #f05030
        }
        th {
            background-color: #e7f1f6;
        }
        td, th {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }
        table {
            border-collapse: collapse;
            width: 96%;
            margin: 15px 2% 0 2%;
            font-size: 17px;
        }
        tr:nth-child(odd) {
            background-color: #f0f7f9;
        }
        </style>
</head>
<body>
    <div id="inserir" style="display: none;">
        <button id="voltar-main" style="border-radius: 3px; padding: 15px; right: 25px; top: 25px; position: fixed; cursor: pointer;">Voltar</button>
        <div style="width: 40%; padding: 10% 30%; text-align: center; font-size: 18px; font-weight: bold;">
            <form id="novo-filme">
                Para inserir um novo filme, preencha seus dados abaixo e clique em "INSERIR!"<br><br>
                Se desejar atualizar um filme existente, é só preencher o campo "Nome" com o nome do filme que deseja atualizar.<br><br>
                IMPORTANTE: Separe o nome de autores / diretores com ";". Não com espaço, não com vírgula. Com ";" (ponto e vírgula).
                <br><br><br>
                Nome: <input type="text" id="nome-ins" maxlength="50" style="font-size: 18px; width: 300px;"><br><br>
                Duração (minutos): <input type="number" id="dur-ins" maxlength="3" style="font-size: 18px; width: 300px;"><br><br>
                Ano de Lançamento: <input type="number" id="ano-ins" maxlength="4" style="font-size: 18px; width: 300px;"><br><br>
                Atores (separados por ;): <input type="text" id="atores-ins" style="font-size: 18px; width: 300px;"><br><br>
                Diretores (separador por ;): <input type="text" id="diretores-ins" style="font-size: 18px; width: 300px;"><br><br><br>
                <button style="border-radius: 3px; padding: 15px; cursor: pointer;" id="inserir-dados">INSERIR!</button>

            </form>
        </div>

    </div>
    <div style="width: 100%" id="main">

        <div style="width: 100%;">
            <img src="./logo.png" width="125" style="display: inline-block; position: fixed;"/>
            <button id="inserir-novo" style="border-radius: 3px; padding: 15px; right: 25px; top: 25px; position: fixed; cursor: pointer;">Inserir Novo</button>
        </div>
        <div style="display: block; font-size: 30px; font-weight: bold; padding: 25px; text-align: center;">
            CATÁLOGO NETFLIX
        </div>
        <div style="width: 80%; padding: 20px 10% 0 10%">
            <form>
                <div style="width: 100%; display: block; text-align: center; font-size: 21px; padding: 0px 0px 20px 0px; font-weight: bold;">Filtros de Pesquisa:<br></div>
                <div style="width: 33%; display: inline-block; text-align: center; font-size: 18px;">
                    Filme
                    <br>
                    <input type="radio" name="filtro" value="filme" checked="checked">
                </div>
                <div style="width: 33%; display: inline-block; text-align: center; font-size: 18px;">
                    Ator
                    <br>
                    <input type="radio" name="filtro" value="ator">
                </div>
                <div style="width: 33%; display: inline-block; text-align: center; font-size: 18px;">
                    Diretor
                    <br>
                    <input type="radio" name="filtro" value="diretor">
                </div>

                <input type="text" id="pesquisa" style="width: 50%; margin: 25px 2% 0 13%; font-size: 17px; padding: 7px 10px 7px 10px;" placeholder="Pesquisa..."/>
                <input type="button" id="pesquisar" style="width: 20%; margin: 25px 0 0 2%; font-size: 17px; padding: 7px 10px 7px 10px;" value="Pesquisar!">

                <div style="width: 60%; text-align: center; margin-top: 45px; margin-left: 20%; margin-right: 20%;">
                    <span style="font-size: 20px; font-weight: bold;">Ordem:</span><br>
                    <div style="display: flex">
                        <div style="width: 50%; text-align: center; font-size: 18px; margin-top: 15px;">
                            Crescente
                            <br>
                            <input type="radio" name="ordem" value="crescente" checked="checked">
                        </div>
                        <div style="width: 50%; text-align: center; font-size: 18px; margin-top: 15px;">
                            Decrescente
                            <br>
                            <input type="radio" name="ordem" value="decrescente">
                        </div>
                    </div>
                </div>
                
                
            </div>
            <div style="padding: 0 2%;">
                <div id="pesquisando" style="display: none; font-weight: bold; font-size: 30px; text-align: center; margin-top: 30px;">Pesquisando...</div>
                <div id="vazio" style="display: none; font-weight: bold; font-size: 30px; text-align: center; margin-top: 30px;">Nenhum Dado Encontrado!</div>
                <table id="tabelaDados">
                    <tr>
                        <th style="width: 3.5%">ID</th>
                        <th style="width: 34%">Nome</th>
                        <th style="width: 17.5%">Duração e<br>Lançamento</th>
                        <th style="width: 21%">Diretores</th>
                        <th style="width: 21%">Atores</th>
                        <th style="width: 3%">X</th>
                    </tr>
                    <tr>
                        <td style="width: 3.5%"></td>
                        <td style="width: 34%"></td>
                        <td style="width: 17.5%"></td>
                        <td style="width: 21%"></td>
                        <td style="width: 21%"></td>
                        <td style="width: 3%"></td>
                    </tr>
                </table>
                
            </div>
        </form>
    
    </div>

    <script type="text/javascript" src="/eel.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>
        var tabelaBase = "<tr>  <th style='width: 3.5%'>ID</th> <th style='width: 34%'>Nome</th> <th style='width: 17.5%'>Duração e<br>Lançamento</th>  <th style='width: 21%'>Diretores</th>  <th style='width: 21%'>Atores</th> <th style='width: 3%'>X</th> </tr>";
        var linhaExtra = "<tr>  <td style='width: 3.5%'>{{id}}</td>  <td style='width: 34%'>{{nome}}</td>  <td style='width: 17.5%'>{{ano_dur}}</td>  <td style='width: 21%'>{{diretores}}</td>  <td style='width: 21%'>{{atores}}</td> <td style='width: 3%'><button class='apagar' id-alvo='{{id-base}}'>X</button></td> </tr>"

        var ultima_pesquisa = [];

        var ordenacaoInversa = false;

        var filmeBase = {
            id: "",
            nome: "",
            ano: 1900,
            dur: 150,
            diretores: [''],
            atores: ['']
        }


        function getDados(){
            //chamar python
            pesquisa();
        }

        function repl(str, chave, dado){
            var reg = new RegExp("{{" + chave + "}}", "ig");
            return str.replace(reg, dado);
        }

        function textoDuracao(tempo){
            tempo = Number(tempo);
            tempo = Math.round(tempo);
            var dur = Math.floor(tempo / 60);
            dur += "h ";
            var min = tempo % 60;
            if(min) {
                dur += min + "min";
            }
            return dur;
        }


        function processaDados(dados){
            var strFinal = "";
            strFinal += tabelaBase;
            for(var filme of dados){
                str = linhaExtra;

                str = repl(str, "id", "s"+filme.id);
                str = repl(str, "id-base", filme.id);
                str = repl(str, "nome", filme.nome);

                var anoDuracao = textoDuracao(filme.dur) + "<br>-<br>" + filme.ano;


                str = repl(str, "ano_dur", anoDuracao);

                var diretores = "";

                for(var dir in filme.diretores){
                    if(dir < filme.diretores.length - 1){
                        diretores += filme.diretores[dir] + "<br>";
                    } else {
                        diretores += filme.diretores[dir];
                    }
                }

                str = repl(str, "diretores", diretores);

                var atores = "";

                for(var at in filme.atores){
                    if(at < filme.atores.length - 1){
                        atores += filme.atores[at] + "<br>";
                    } else {
                        atores += filme.atores[at];
                    }
                }

                str = repl(str, "atores", atores);

                strFinal += str;
            }

            return strFinal;
        }

        function apagar(){

            
            var id = $(this).attr('id-alvo');
            var escolha = confirm("Tem certeza de que deseja apagar o filme de ID s"+ id +"?");
            var trPai = $(this).parent().parent();

            if(escolha){
                trPai.remove();
                eel.removerPy(id);

                for(filme in ultima_pesquisa){
                    if(ultima_pesquisa[filme].id == id){
                        ultima_pesquisa.splice(filme, 1);
                    }
                }

                setTimeout(()=>{alert("Filme apagado com sucesso")}, 20);
            } else {
                alert("Sábia escolha. Quase nenhum filme merece ser apagado.");
            }
        }


        function inserir(){

            var nome = $("#nome-ins").val();
            var dur = $("#dur-ins").val();
            var ano = $("#ano-ins").val();
            var atores = $("#atores-ins").val();
            var diretores = $("#diretores-ins").val();

            if(nome != ""){
                alert('1')
                console.log(atores, diretores)
                eel.inserirFilmePy(nome, dur, ano, atores, diretores);
                alert("Mudança realizada com sucesso!")
                voltarMain();
            } else {
                alert('2')
                alert("O campo 'Nome' é obrigatório!")
            }


        }

        function populaDados(dados){
            console.log(dados);
            var tabelaHtml = processaDados(dados);
            $("#tabelaDados").html(tabelaHtml);
            $(".apagar").click(apagar);


        }

        function inserirNovo(){
            $("#main").hide();
            $("#inserir-novo").hide();

            $("#inserir").show();
            $("#voltar-main").show();
        }

        function voltarMain(){
            $("#inserir").hide();
            $("#voltar-main").hide();

            $("#main").show();
            $("#inserir-novo").show();
        }


        $(document).ready(()=>{
            /*var dados = getDados();
            var tabelaHtml = processaDados(dados);
            $("#tabelaDados").html(tabelaHtml);*/
            $("#pesquisar").click(pesquisa);
            //$("#pesquisa").on('keydown', pesquisa);
            pesquisa();

            $("#inserir-novo").click(inserirNovo);
            $("#voltar-main").click(voltarMain)
            $("#inserir-dados").click(inserir);

            $(".apagar").click(apagar);

            $("input[name=ordem]").on('click change', ()=>{
                var valor = $("input[name=ordem]:checked").val();
                if(valor == 'crescente'){
                    if(ordenacaoInversa){
                        ordenacaoInversa = false;
                        ultima_pesquisa = inverte(ultima_pesquisa);
                        populaDados(ultima_pesquisa);
                    } else {
                        ordenacaoInversa = false;
                    }
                } else {
                    if(ordenacaoInversa){
                        ordenacaoInversa = true;
                    } else {
                        ordenacaoInversa = true;
                        ultima_pesquisa = inverte(ultima_pesquisa);
                        populaDados(ultima_pesquisa);
                    }
                }
                
            });
        });


        eel.expose(populaTabelaJs);
        function populaTabelaJs(jsonDados){
            $("#vazio").hide()
            $("#pesquisando").hide()
            $("#tabelaDados").show()

            if(typeof jsonDados == "string" && jsonDados.toUpperCase() == "FALSE"){
                console.log('vazio')
                $("#vazio").show()
                $("#pesquisando").hide();
                $("#tabelaDados").html(tabelaBase + linhaExtra.replace(/{{[^{}]*}}/ig, ""));
                $("#tabelaDados").show();
                return;
            }

            dados = JSON.parse(jsonDados);

            dados = merge_sort(dados);

            if(ordenacaoInversa == true){
                dados = inverte(dados);
            }

            ultima_pesquisa = dados;

            populaDados(ultima_pesquisa);
        }


        function inverte(dados){
            dados.reverse();
            return dados;
        }


       
        function pesquisa(){
            $("#tabelaDados").hide()
            $("#vazio").hide()
            $("#pesquisando").show()
            var filtro = $('input[name=filtro]:checked').val();
            if(filtro == 'filme'){
                pesquisaFilme();
            } else if(filtro == 'ator'){
                pesquisaAtor();

            } else if(filtro == 'diretor'){
                pesquisaDiretor();

            }
            
        }

        eel.expose(printa);
        function printa(dado){
            console.log(dado);
            return '1';
        }

        function pesquisaFilme(){
            var campo = $("#pesquisa").val();

            eel.pesquisaFilmePy(campo);
            // acende "pesquisando"
        }

        
        function pesquisaAtor(){
            var campo = $("#pesquisa").val();

            eel.pesquisaAtorPy(campo);
            // acende "pesquisando"
        }

        function pesquisaDiretor(){
            var campo = $("#pesquisa").val();

            eel.pesquisaDiretorPy(campo);
            // acende "pesquisando"
        }




        function merge_sort(arr){

            if(typeof arr != "object")
                return arr;

                
            var len = arr.length;
            
            if(len <= 1)
                return arr;

            var meio = Math.floor(arr.length/2);

            var esq = merge_sort(arr.slice(0, meio))
            var dir = merge_sort(arr.slice(meio, len))

            return merge_film(esq, dir);
        }

        function merge_film(arr1, arr2){

            var res = [];

            while (arr1.length > 0 && arr2.length > 0){
                var item1 = String(arr1[0]['nome']).toLowerCase();
                var item2 = String(arr2[0]['nome']).toLowerCase();
                var compare = item1.localeCompare(item2);
                if(compare <= -1){
                    res.push(arr1.shift());
                } else {
                    if(compare >= 1){
                        res.push(arr2.shift());
                    } else {
                        if(arr1[0]['nome'] < arr2[0]['nome']){
                            res.push(arr1.shift());
                        } else {
                            res.push(arr2.shift());
                        }
                    }
                }
            }
            
            while (arr1.length > 0){
                res.push(arr1.shift());                
            }
            
            while (arr2.length > 0){
                res.push(arr2.shift());                
            }
            return res;

        }



    </script>
</body>
</html>